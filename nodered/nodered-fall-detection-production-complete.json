[{"id": "b1c241758a38da4a","type": "tab","label": "Fall Detection - Complete Production","disabled": false,"info": "Complete production system: Flask detection + Telegram alerts + SQL logging + Image capture"},{"id": "5ac6c3b0feda35b4","type": "inject","z": "b1c241758a38da4a","name": "Poll Every 1 Second","props": [{"p": "payload"}],"repeat": "1","crontab": "","once": false,"onceDelay": 0.1,"topic": "","payload": "{}","payloadType": "json","x": 100,"y": 100,"wires": [["800d9dbc58d1d2bc"]]},{"id": "800d9dbc58d1d2bc","type": "http request","z": "b1c241758a38da4a","name": "Get Detection from Flask","method": "GET","ret": "json","paytoqs": "ignore","url": "http://127.0.0.1:5000/api/detection","tls": "","persist": false,"proxy": "","authType": "","senderr": false,"headers": {},"x": 300,"y": 100,"wires": [["cd4880bad66a9f36","0a50c296cc7287a0"]]},{"id": "cd4880bad66a9f36","type": "debug","z": "b1c241758a38da4a","name": "1ï¸âƒ£ Flask Response","active": true,"tosidebar": true,"console": true,"tostatus": false,"complete": "true","targetType": "msg","x": 520,"y": 40,"wires": []},{"id": "0a50c296cc7287a0","type": "function","z": "b1c241758a38da4a","name": "Check if Fall","func": "let detection = msg.payload;\nif (typeof detection === 'string') {\n    try {\n        detection = JSON.parse(detection);\n        node.warn('âœ… PARSED JSON from string');\n    } catch (e) {\n        node.warn('âŒ Failed to parse JSON: ' + e.message);\n        return null;\n    }\n}\n\nnode.warn('CHECK FALL - Payload: ' + JSON.stringify(detection));\nnode.warn('fall_detected value: ' + detection.fall_detected + ' (type: ' + typeof detection.fall_detected + ')');\nnode.warn('confidence value: ' + detection.confidence + ' (type: ' + typeof detection.confidence + ')');\n\nconst CONFIDENCE_THRESHOLD = 0.5;\n\nif (detection && detection.fall_detected === true && detection.confidence >= CONFIDENCE_THRESHOLD) {\n    node.warn('âœ… FALL DETECTED - Confidence: ' + (detection.confidence * 100).toFixed(1) + '% - Waiting 2 seconds to confirm');\n    node.status({fill:\"orange\",shape:\"dot\",text:\"Fall detected - confirming...\"});\n    msg.payload = detection;\n    return msg;\n}\nnode.status({fill:\"green\",shape:\"dot\",text:\"No fall or low confidence\"});\nreturn null;","outputs": 1,"noerr": 0,"initialize": "","finalize": "","libs": [],"x": 520,"y": 100,"wires": [["4fb547ed0b89ca3a","delay_2sec"]]},{"id": "4fb547ed0b89ca3a","type": "debug","z": "b1c241758a38da4a","name": "2ï¸âƒ£ Fall Detected","active": true,"tosidebar": true,"console": true,"tostatus": false,"complete": "payload","targetType": "msg","x": 740,"y": 40,"wires": []},{"id": "delay_2sec","type": "delay","z": "b1c241758a38da4a","name": "Wait 2 Seconds","pauseType": "delay","timeout": "2","timeoutUnits": "seconds","rate": "1","nbRateUnits": "1","rateUnits": "second","randomFirst": "1","randomLast": "5","randomUnits": "seconds","drop": false,"allowrate": false,"outputs": 1,"x": 740,"y": 150,"wires": [["confirm_still_fallen"]]},{"id": "confirm_still_fallen","type": "http request","z": "b1c241758a38da4a","name": "Confirm Fall Status","method": "GET","ret": "json","paytoqs": "ignore","url": "http://127.0.0.1:5000/api/detection","tls": "","persist": false,"proxy": "","authType": "","senderr": false,"headers": {},"x": 960,"y": 150,"wires": [["verify_no_movement"]]},{"id": "verify_no_movement","type": "function","z": "b1c241758a38da4a","name": "Verify Still Fallen","func": "let detection = msg.payload;\nif (typeof detection === 'string') {\n    try {\n        detection = JSON.parse(detection);\n    } catch (e) {\n        return null;\n    }\n}\n\nnode.warn('CONFIRMATION CHECK - Fall: ' + detection.fall_detected + ', Motion: ' + detection.motion + ', Confidence: ' + detection.confidence);\n\nconst CONFIDENCE_THRESHOLD = 0.5;\nconst MOTION_THRESHOLD = 1000;\n\nif (detection && detection.fall_detected === true && detection.confidence >= CONFIDENCE_THRESHOLD && detection.motion < MOTION_THRESHOLD) {\n    node.warn('âœ… CONFIRMED - Person still fallen and not moving significantly');\n    node.status({fill:\"red\",shape:\"dot\",text:\"Confirmed fall - sending alerts\"});\n    msg.payload = detection;\n    return msg;\n}\n\nnode.warn('âŒ REJECTED - Person recovered or moving too much. Motion: ' + detection.motion);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"False alarm - person recovered\"});\nreturn null;","outputs": 1,"noerr": 0,"initialize": "","finalize": "","libs": [],"x": 1180,"y": 150,"wires": [["0dc29da9318dc71b","a422feb5476f17c4","b1062c9328aaa585"]]},{"id": "0dc29da9318dc71b","type": "http request","z": "b1c241758a38da4a","name": "Get Image from Flask","method": "GET","ret": "bin","paytoqs": "ignore","url": "http://127.0.0.1:5000/api/frame","tls": "","persist": false,"proxy": "","authType": "","senderr": false,"headers": {},"x": 740,"y": 100,"wires": [["1d73c337e20f9849","e7f0f526801a658e"]]},{"id": "1d73c337e20f9849","type": "debug","z": "b1c241758a38da4a","name": "3ï¸âƒ£ Image Captured","active": true,"tosidebar": true,"console": true,"tostatus": false,"complete": "true","targetType": "msg","x": 960,"y": 40,"wires": []},{"id": "a422feb5476f17c4","type": "function","z": "b1c241758a38da4a","name": "Prepare Text Alert","func": "let detection = msg.payload;\nif (typeof detection === 'string') {\n    try {\n        detection = JSON.parse(detection);\n    } catch (e) {\n        return null;\n    }\n}\n\nconst now = new Date();\nconst timestamp = now.toLocaleString();\n\nconst messageText = `ðŸš¨ FALL DETECTED ðŸš¨\\n\\nðŸ“ Location: Living Room\\nâ° Time: ${timestamp}\\nðŸ“Š Confidence: ${(detection.confidence * 100).toFixed(1)}%\\nðŸ“· Camera: camera-001\\n\\nâš ï¸ IMMEDIATE ACTION REQUIRED\\nCheck on resident immediately!`;\n\nmsg.payload = {\n    chatId: 5145469528,\n    content: messageText,\n    type: 'message'\n};\n\n\nnode.warn('TEXT ALERT PREPARED');\nreturn msg;","outputs": 1,"timeout": "","noerr": 0,"initialize": "","finalize": "","libs": [],"x": 960,"y": 100,"wires": [["7e4e4b192779c264","53d5f012f6b1a312"]]},{"id": "7e4e4b192779c264","type": "debug","z": "b1c241758a38da4a","name": "4ï¸âƒ£ Text Alert Ready","active": true,"tosidebar": true,"console": true,"tostatus": false,"complete": "payload","targetType": "msg","x": 1180,"y": 40,"wires": []},{"id": "53d5f012f6b1a312","type": "telegram sender","z": "b1c241758a38da4a","name": "Send Text Alert","bot": "e5db92552fbca474","haserroroutput": false,"outputs": 1,"x": 1180,"y": 100,"wires": [["a80df5c91e481053"]]},{"id": "a80df5c91e481053","type": "debug","z": "b1c241758a38da4a","name": "5ï¸âƒ£ Text Sent","active": true,"tosidebar": true,"console": true,"tostatus": true,"complete": "true","targetType": "msg","statusVal": "âœ… Text sent","statusType": "auto","x": 1380,"y": 100,"wires": []},{"id": "e7f0f526801a658e","type": "function","z": "b1c241758a38da4a","name": "Prepare Image Alert","func": "// Store image buffer for later use\nmsg.imageBuffer = msg.payload;\n\nconst now = new Date();\nconst timestamp = now.toLocaleString();\n\nconst caption = `ðŸš¨ FALL DETECTED ðŸš¨\\nâ° ${timestamp}\\nðŸ“· Camera: camera-001`;\n\nmsg.payload = {\n    chatId: 5145469528,\n    type: 'photo',\n    content: msg.imageBuffer,\n    caption: caption\n};\n\n\nnode.warn('IMAGE ALERT PREPARED');\nreturn msg;\n","outputs": 1,"timeout": "","noerr": 0,"initialize": "","finalize": "","libs": [],"x": 960,"y": 150,"wires": [["012bc539b9ef5e48","cf2cb00202a41129"]]},{"id": "012bc539b9ef5e48","type": "debug","z": "b1c241758a38da4a","name": "6ï¸âƒ£ Image Alert Ready","active": true,"tosidebar": true,"console": true,"tostatus": false,"complete": "true","targetType": "msg","x": 1180,"y": 150,"wires": []},{"id": "cf2cb00202a41129","type": "telegram sender","z": "b1c241758a38da4a","name": "Send Image Alert","bot": "e5db92552fbca474","haserroroutput": false,"outputs": 1,"x": 1380,"y": 150,"wires": [["0f82b8910757ee8d"]]},{"id": "0f82b8910757ee8d","type": "debug","z": "b1c241758a38da4a","name": "7ï¸âƒ£ Image Sent","active": true,"tosidebar": true,"console": true,"tostatus": true,"complete": "true","targetType": "msg","statusVal": "âœ… Image sent","statusType": "auto","x": 1580,"y": 150,"wires": []},{"id": "b1062c9328aaa585","type": "function","z": "b1c241758a38da4a","name": "Prepare SQL Insert","func": "let detection = msg.payload;\nif (typeof detection === 'string') {\n    try {\n        detection = JSON.parse(detection);\n    } catch (e) {\n        return null;\n    }\n}\n\nconst now = new Date();\n// Convert to MySQL datetime format: YYYY-MM-DD HH:MM:SS\nconst timestamp = now.getFullYear() + '-' + \n    String(now.getMonth() + 1).padStart(2, '0') + '-' + \n    String(now.getDate()).padStart(2, '0') + ' ' +\n    String(now.getHours()).padStart(2, '0') + ':' +\n    String(now.getMinutes()).padStart(2, '0') + ':' +\n    String(now.getSeconds()).padStart(2, '0');\n\nmsg.topic = 'INSERT INTO fall_detection_alerts (timestamp, confidence, camera_id, location, status) VALUES (?, ?, ?, ?, ?)';\n\nmsg.payload = [\n    timestamp,\n    detection.confidence,\n    'camera-001',\n    'Living Room',\n    'ACTIVE'\n];\n\nnode.warn('SQL QUERY PREPARED: ' + JSON.stringify(msg.payload));\nreturn msg;\n","outputs": 1,"timeout": "","noerr": 0,"initialize": "","finalize": "","libs": [],"x": 740,"y": 200,"wires": [["7869103497a3c659","62de885cf6d41a32"]]},{"id": "7869103497a3c659","type": "debug","z": "b1c241758a38da4a","name": "8ï¸âƒ£ SQL Query","active": true,"tosidebar": true,"console": true,"tostatus": false,"complete": "payload","targetType": "msg","x": 960,"y": 200,"wires": []},{"id": "62de885cf6d41a32","type": "mysql","z": "b1c241758a38da4a","mydb": "5805dd211e01f614","name": "Insert to MySQL","x": 1180,"y": 200,"wires": [["8bb2cfddb037403d"]]},{"id": "8bb2cfddb037403d","type": "debug","z": "b1c241758a38da4a","name": "9ï¸âƒ£ SQL Result","active": true,"tosidebar": true,"console": true,"tostatus": true,"complete": "true","targetType": "msg","statusVal": "âœ… Logged to DB","statusType": "auto","x": 1380,"y": 200,"wires": []},{"id": "b45a315c302fbf85","type": "inject","z": "b1c241758a38da4a","name": "Manual Test - Simulate Fall","props": [{"p": "payload","v": "{\"fall_detected\":true,\"confidence\":0.58,\"aspect_ratio\":1.78,\"motion\":505,\"timestamp\":1770894042.97}","vt": "json"}],"repeat": "","crontab": "","once": false,"onceDelay": 0.1,"topic": "","x": 100,"y": 300,"wires": [["0a50c296cc7287a0"]]},{"id": "e5db92552fbca474","type": "telegram bot","botname": "falldetectionelderlybot","usernames": "","chatids": "5145469528","baseapiurl": "","testenvironment": false,"updatemode": "polling","pollinterval": 300,"usesocks": false,"sockshost": "","socksprotocol": "socks5","socksport": 6667,"socksusername": "anonymous","sockspassword": "","bothost": "","botpath": "","localbothost": "0.0.0.0","localbotport": 8443,"publicbotport": 8443,"privatekey": "","certificate": "","useselfsignedcertificate": false,"sslterminated": false,"verboselogging": false},{"id": "5805dd211e01f614","type": "MySQLdatabase","name": "","host": "127.0.0.1","port": "3306","db": "elderly_care_system","tz": "","charset": "UTF8"},{"id": "1684c90c94967179","type": "global-config","env": [],"modules": {"node-red-contrib-telegrambot": "17.0.5","node-red-node-mysql": "3.0.0"}}]
